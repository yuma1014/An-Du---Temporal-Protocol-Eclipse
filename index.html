<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>æš—æ¸¡-æ™‚åŸŸå”è­°ï¼šæ—¥è•</title>
    
    <link rel="manifest" href="manifest.json">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="æš—æ¸¡">
    <meta name="theme-color" content="#111111">
    
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="icon" type="image/png" href="logo.png">

    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;900&family=Cinzel:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- è®Šæ•¸è¨­å®š --- */
        :root {
            --logo-url: url('logo.png'); 
            --bg-img: url('bg-night-pc.png'); 
            
            --ghost-cyan: #00ffbf; 
            --spider-lily: #ff3b3b;
            --bone-white: #e0e0e0;
            --ash-gray: #7a7a7a;
            
            --obsidian-bg: rgba(20, 20, 25, 0.75);
            --obsidian-border: rgba(0, 255, 191, 0.2); 
            
            --radius-box: 28px;
            --radius-input: 12px;
            --radius-btn: 14px;
        }

        * {
            box-sizing: border-box; margin: 0; padding: 0;
            transition: all 0.4s cubic-bezier(0.25, 0.1, 0.25, 1);
            -webkit-tap-highlight-color: transparent;
            font-family: "Cinzel", "Noto Serif TC", serif;
        }

        html, body {
            width: 100%; height: 100%;
            overflow-x: hidden;
            background-color: #111111; 
        }
        
        body {
            color: var(--bone-white);
            background: transparent; 
            overscroll-behavior-y: none;
            display: flex; flex-direction: column;
        }

        .bg-fixed { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; 
            opacity: 0.4; 
            background-image: 
                radial-gradient(circle at center, rgba(26,26,26,0.5) 0%, #111111 100%), 
                var(--bg-img);
            background-size: cover; 
            background-position: center;
            background-blend-mode: overlay;
        }

        .app-layout {
            flex: 1; width: 100vw;
            overflow-y: auto; overflow-x: hidden;
            scroll-behavior: smooth; padding-bottom: 40px;
        }

        section {
            width: 100%; min-height: 100vh;
            display: flex; justify-content: center; align-items: center;
            padding: 20px; position: relative;
        }

        #app-section { 
            z-index: 2; 
            padding-top: max(20px, env(safe-area-inset-top)); 
            padding-bottom: max(20px, env(safe-area-inset-bottom));
        }
        
        .obsidian-container {
            width: 100%; max-width: 520px;
            background: var(--obsidian-bg);
            backdrop-filter: saturate(120%) blur(30px); 
            -webkit-backdrop-filter: saturate(120%) blur(30px);
            border-radius: var(--radius-box); 
            border: 1px solid var(--obsidian-border);
            box-shadow: 0 20px 60px rgba(0,0,0,0.6), inset 0 0 20px rgba(0, 255, 191, 0.05);
            padding: 2.5rem;
            display: flex; flex-direction: column;
            gap: 1.2rem;
            position: relative;
            animation: border-pulse 8s infinite ease-in-out;
            margin: auto 0;
        }

        @keyframes border-pulse {
            0%, 100% { border-color: rgba(0, 255, 191, 0.1); }
            50% { border-color: rgba(0, 255, 191, 0.3); box-shadow: 0 20px 60px rgba(0,0,0,0.8), inset 0 0 30px rgba(0, 255, 191, 0.1); }
        }

        header { display: flex; flex-direction: column; align-items: center; margin-bottom: 0.5rem; text-align: center; }
        
        .logo {
            width: 110px; height: 110px; margin-bottom: 20px; 
            border-radius: 24px;
            border: 1px solid rgba(0, 255, 191, 0.3);
            background-image: var(--logo-url); background-size: cover; background-position: center;
            box-shadow: 0 8px 20px rgba(0,0,0,0.5);
        }
        
        h1 { 
            font-size: 2rem; font-weight: 900; letter-spacing: 0.15em; 
            color: var(--bone-white); 
            text-shadow: 0 2px 10px rgba(0,0,0,0.8);
            margin-bottom: 5px;
        }
        .subtitle { 
            font-size: 0.7rem; color: var(--ghost-cyan); 
            letter-spacing: 0.2em; text-transform: uppercase; opacity: 0.8;
        }

        .expiry-badge {
            margin-top: 12px; font-size: 0.75rem;
            color: var(--spider-lily);
            background: rgba(255, 59, 59, 0.1);
            border: 1px solid rgba(255, 59, 59, 0.2);
            padding: 6px 16px; border-radius: 20px;
            letter-spacing: 0.05em; display: inline-block; font-weight: 600;
        }

        .input-group { display: flex; flex-direction: column; gap: 8px; }
        label { 
            font-size: 0.8rem; font-weight: 600; color: var(--ash-gray); margin-left: 6px; 
            letter-spacing: 0.05em; text-transform: uppercase;
        }
        
        input[type="text"] {
            width: 100%; 
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--ghost-cyan); padding: 16px;
            font-size: 1rem; font-family: 'Cinzel', 'Noto Serif TC', serif;
            border-radius: var(--radius-input);
        }
        input:focus { 
            outline: none; background: rgba(0, 255, 191, 0.05);
            border-color: rgba(0, 255, 191, 0.4);
        }

        .file-drop-zone {
            width: 100%; height: 110px;
            background: rgba(255, 255, 255, 0.03);
            border: 2px dashed rgba(122, 122, 122, 0.4);
            border-radius: var(--radius-input);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            cursor: pointer; position: relative;
            text-align: center; padding: 10px;
        }
        .file-drop-zone input[type="file"] {
            position: absolute; width: 100%; height: 100%; top: 0; left: 0; opacity: 0; cursor: pointer;
        }
        .drop-title { font-size: 0.95rem; font-weight: 600; color: var(--bone-white); pointer-events: none;}
        .drop-desc { font-size: 0.7rem; color: var(--ash-gray); margin-top: 5px; pointer-events: none; opacity: 0.7; }
        
        .btn-group { display: flex; gap: 12px; margin-top: 0.8rem; }
        button {
            flex: 1; padding: 16px; border: none; 
            border-radius: var(--radius-btn);
            font-size: 1rem; font-weight: 600; cursor: pointer; letter-spacing: 0.1em; 
            display: flex; align-items: center; justify-content: center;
            -webkit-tap-highlight-color: transparent;
        }
        
        .btn-encrypt { 
            background: linear-gradient(135deg, #0b4f43 0%, #004d40 100%);
            color: var(--ghost-cyan);
            border: 1px solid rgba(0, 255, 191, 0.2);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .btn-encrypt:active { transform: scale(0.96); }
        
        .btn-decrypt { 
            background: rgba(255, 255, 255, 0.1); 
            color: var(--bone-white); 
            border: 1px solid rgba(255,255,255,0.1);
        }
        .btn-decrypt:active { transform: scale(0.96); }

        .status-container { margin-top: 15px; text-align: center; }
        .progress-bar {
            width: 100%; height: 4px; background: rgba(255,255,255,0.1);
            border-radius: 2px; overflow: hidden; margin-bottom: 10px; display: none;
        }
        .progress-fill {
            width: 0%; height: 100%; background: var(--ghost-cyan);
            box-shadow: 0 0 10px var(--ghost-cyan);
            transition: width 0.2s ease;
        }
        .status-msg { 
            font-size: 0.8rem; color: var(--ghost-cyan); 
            min-height: 20px; font-weight: 500;
        }

        .result-area {
            display: none; flex-direction: column; gap: 15px;
            margin-top: 15px;
            animation: emerge 0.6s ease-out forwards;
            border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;
        }
        @keyframes emerge { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        video {
            width: 100%; border-radius: var(--radius-input);
            background: #000; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .download-link {
            text-decoration: none; padding: 14px; 
            border-radius: var(--radius-btn);
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: var(--bone-white);
            text-align: center; font-weight: 600; font-size: 0.9rem; letter-spacing: 0.1em;
            display: block;
        }

        .scroll-indicator {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            color: var(--ash-gray); 
            animation: float 3s infinite ease-in-out;
            font-size: 1.5rem; cursor: pointer; z-index: 10;
        }
        @keyframes float {
            0%, 100% {transform: translateX(-50%) translateY(0); opacity: 0.3;}
            50% {transform: translateX(-50%) translateY(-10px); opacity: 1;}
        }

        /* --- Info Section Layout --- */
        #info-section { 
            z-index: 2; padding-top: 60px; padding-bottom: 80px; 
            background: linear-gradient(to top, #000 0%, transparent 100%);
        }
        .info-container { width: 100%; max-width: 960px; display: flex; flex-direction: column; gap: 50px; padding: 0 20px; }
        
        .info-title {
            font-size: 3rem; font-weight: 900; line-height: 1.2;
            color: var(--bone-white); text-align: center;
            text-shadow: 0 0 20px rgba(255,255,255,0.15);
            letter-spacing: 0.05em;
        }
        .info-desc { 
            font-size: 1.1rem; color: var(--ash-gray); text-align: center;
            max-width: 600px; margin: 0 auto; line-height: 1.8;
            font-weight: 500;
        }

        .features-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; }
        .feature-card {
            background: rgba(20, 20, 25, 0.6); 
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 24px;
            padding: 40px 20px; text-align: center;
        }
        .icon-large { font-size: 3rem; margin-bottom: 20px; display: block; filter: grayscale(1); }
        .card-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 10px; color: var(--bone-white); }
        .card-text { font-size: 0.9rem; color: var(--ash-gray); line-height: 1.6; }
        
        .main-footer { 
            text-align: center; margin-top: 60px; color: #444; font-size: 0.7rem; 
            letter-spacing: 0.2em; border-top: 1px solid #111; padding-top: 20px;
        }

        @media (max-width: 900px) {
            .obsidian-container { padding: 1.5rem; width: 90%; margin: 0 auto;}
            .logo { width: 90px; height: 90px; margin-bottom: 15px; }
            h1 { font-size: 1.6rem; }
            input[type="text"] { font-size: 16px; padding: 14px; }
            .btn-group { flex-direction: column; gap: 10px; }
            button { padding: 14px; width: 100%; }
            .info-title { font-size: 1.8rem; }
            .features-grid { grid-template-columns: 1fr; gap: 30px; }
            .feature-card { padding: 50px 30px; }
        }

        .observe-target { opacity: 0; transform: translateY(20px); }
        .emerge-up { opacity: 1 !important; transform: translateY(0) !important; }
    </style>
</head>
<body>
    <div class="bg-fixed"></div>

    <div class="app-layout">
        <section id="app-section">
            <div class="obsidian-container">
                <header>
                    <div class="logo"></div>
                    <h1>æš—æ¸¡</h1>
                    <div class="subtitle">Temporal Protocol: Eclipse</div>
                    <div id="key-expiry-display" class="expiry-badge">è¨ˆç®—å¤©æ•¸...</div>
                </header>
                
                <div class="input-group">
                    <label>Access Token (é€šè¡Œå¯†ä»¤)</label>
                    <input type="text" id="password" placeholder="åœ¨æ­¤éŠ˜åˆ»å¯†é‘°..." autocomplete="off">
                </div>
                
                <div class="input-group">
                    <label>Media Source (å½±åƒè¼‰é«”)</label>
                    <div class="file-drop-zone" id="drop-zone">
                        <input type="file" id="file-input" accept="video/*, image/png, .txt">
                        <div class="drop-title" id="file-name">é»æ“Šæˆ–æ‹–æ›³æª”æ¡ˆè‡³æ­¤</div>
                        <div class="drop-desc">MP4 å°è£ / è®€å–åŠ å¯†PNGåœ–ç‰‡</div>
                    </div>
                </div>
                
                <div class="status-container">
                    <div class="progress-bar" id="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
                    <div id="status-log" class="status-msg">éœé»˜å¾…å‘½</div>
                </div>

                <div class="btn-group">
                    <button class="btn-encrypt" onclick="processVideo('encrypt')">å°è£ (åŠ å¯†)</button>
                    <button class="btn-decrypt" onclick="processVideo('decrypt')">é¡¯å½± (è§£å¯†)</button>
                </div>
                
                <div class="result-area" id="result-area">
                    <div id="video-wrapper" style="display:none;">
                        <label>Revenant Playback</label>
                        <video id="player" controls playsinline></video>
                    </div>
                    <div id="download-wrapper" style="display:none;">
                        <a id="download-btn" class="download-link" href="#" download>ä¸‹è¼‰åŠ å¯†åœ–ç‰‡ (.png)</a>
                        <div style="text-align:center; font-size:0.7rem; color:var(--ash-gray); margin-top:8px;">
                            æ‰‹æ©Ÿè«‹é»æ“Šå¾Œã€Œé•·æŒ‰åœ–ç‰‡ã€åŠ å…¥ç›¸ç°¿
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="scroll-indicator" onclick="document.getElementById('info-section').scrollIntoView({behavior: 'smooth'})">â–¼</div>
        </section>

        <section id="info-section">
            <div class="info-container">
                <div class="info-header">
                    <div class="info-title observe-target">éš±æ–¼ç›¸ç°¿ï¼Œé–±å¾Œå³ç„šã€‚</div>
                    <div class="info-desc observe-target">
                        å°‡å½±åƒå°å°æ–¼çœ‹ä¼¼æ™®é€šçš„ã€Œåœ–ç‰‡ã€ä¹‹ä¸­ã€‚<br>
                        å­˜æ–¼æ‰‹æ©Ÿç›¸ç°¿ï¼Œå¤–äººçœ‹ä¾†åªæ˜¯ä¸€å¼µæ•¸ä½ç¬¦å’’ã€‚<br>
                        æ™¨é˜æ•²éŸ¿ä¹‹æ™‚ï¼ˆ08:00 AMï¼‰ï¼Œè§£å¯†æ¬Šé™å°‡æ°¸ä¹…å¤±æ•ˆã€‚
                    </div>
                </div>
                
                <div class="features-grid">
                    <div class="feature-card observe-target">
                        <span class="icon-large">ğŸ–¼ï¸</span>
                        <div class="card-title">åœ–ç‰‡å½è£è¡“</div>
                        <div class="card-text">åŠ å¯†å¾Œçš„å½±ç‰‡å°‡å½è£æˆ PNG æ ¼å¼çš„ã€Œæ•¸ä½ç¬¦å’’ã€ã€‚å¯ç›´æ¥ä¸‹è¼‰è‡³æ‰‹æ©Ÿç›¸ç°¿ï¼Œèˆ‡æ—¥å¸¸ç…§ç‰‡æ··ç‚ºä¸€é«”ã€‚</div>
                    </div>
                    <div class="feature-card observe-target">
                        <span class="icon-large">ğŸ›¡ï¸</span>
                        <div class="card-title">éœ“å–ƒè‡ªç ”åŠ å¯†</div>
                        <div class="card-text">æ¡ç”¨ AES-256 GCM ç®—æ³•ã€‚å¯†æ–‡è¢«éš±å¯«æ–¼åœ–ç‰‡æ•¸æ“šåº•å±¤ï¼Œç„¡æ­£ç¢ºé‡‘é‘°èˆ‡æ™‚é–“ï¼Œåƒ…æ˜¯ä¸€å¼µæ™®é€šåœ–ç‰‡ã€‚</div>
                    </div>
                    <div class="feature-card observe-target">
                        <span class="icon-large">â³</span>
                        <div class="card-title">æ—¥è•ç•Œç·š</div>
                        <div class="card-text">é‡‘é‘°èˆ‡ NST (UTC+8) ç¶å®šã€‚éŒ¯éä»Šæ—¥ï¼Œåœ–ç‰‡å…§çš„å¯†æ–‡å°‡æ°¸ä¹…ä¸Šé–ï¼Œç„¡æ³•é‚„åŸã€‚</div>
                    </div>
                </div>

                <footer class="main-footer observe-target">
                    <div id="copyright-text"></div>
                    DESIGNED BY Ni Nan - æš—æ¸¡ Temporal Protocol
                </footer>
            </div>
        </section>
    </div>

<script>
    // --- UI é‚è¼¯ ---
    const fileInput = document.getElementById('file-input');
    const fileNameDisplay = document.getElementById('file-name');
    
    fileInput.addEventListener('change', (e) => {
        if(e.target.files.length > 0) {
            fileNameDisplay.textContent = e.target.files[0].name;
            fileNameDisplay.style.color = "var(--ghost-cyan)";
        }
    });

    const observer = new IntersectionObserver((entries, obs) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('emerge-up');
                obs.unobserve(entry.target);
            }
        });
    }, { threshold: 0.15 });
    document.querySelectorAll('.observe-target').forEach(el => observer.observe(el));

    // æ™‚é–“é‚è¼¯
    function updateTimeAndTheme() {
        const now = new Date();
        const year = now.getFullYear();
        document.getElementById('copyright-text').innerHTML = `&copy;${year} æš—æ¸¡-æ™‚åŸŸå”è­°ï¼šæ—¥è•`;
        document.getElementById('key-expiry-display').textContent = `å¤±æ•ˆç•Œç·šï¼šæ˜æ—¥ 08:00 AM`;
    }
    updateTimeAndTheme(); setInterval(updateTimeAndTheme, 60000);

    // --- åŠ å¯†æ ¸å¿ƒé‚è¼¯ ---
    const statusLog = document.getElementById('status-log');
    const progressBar = document.getElementById('progress-bar');
    const progressFill = document.getElementById('progress-fill');
    
    // å®šç¾©åˆ†éš”ç¬¦è™Ÿ (Magic String) ç”¨æ–¼å€åˆ†åœ–ç‰‡æ•¸æ“šèˆ‡å¯†æ–‡
    const SEPARATOR_STR = "::NINAN_ECLIPSE_PAYLOAD::";
    const encoder = new TextEncoder();
    const decoder = new TextDecoder();
    const SEPARATOR = encoder.encode(SEPARATOR_STR);

    function setStatus(msg, color, percent) {
        statusLog.textContent = msg;
        statusLog.style.color = color || "var(--ghost-cyan)";
        statusLog.style.textShadow = `0 0 5px ${color || "var(--ghost-cyan)"}`;
        if(percent !== undefined) {
            progressBar.style.display = 'block';
            progressFill.style.width = percent + '%';
        } else {
            progressBar.style.display = 'none';
        }
    }

    async function getTrustedTimestamp() {
        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 3000); 
            const response = await fetch('https://worldtimeapi.org/api/timezone/Etc/UTC', { 
                cache: 'no-store', signal: controller.signal
            });
            clearTimeout(timeoutId);
            if (!response.ok) throw new Error('Time API Error');
            const data = await response.json();
            return data.unixtime; 
        } catch (e) {
            console.warn("ç¶²è·¯æ ¡æ™‚é€¾æ™‚ï¼Œåˆ‡æ›è‡³æœ¬åœ°æ™‚é–“ã€‚", e);
            const oldColor = statusLog.style.color;
            statusLog.style.color = "var(--spider-lily)";
            setTimeout(() => { statusLog.style.color = oldColor; }, 2000);
            return Math.floor(Date.now() / 1000);
        }
    }

    async function deriveKey(password, salt) {
        const nowSeconds = await getTrustedTimestamp();
        const dayId = Math.floor(nowSeconds / 86400); 
        const keyMaterialStr = password + "_" + dayId.toString();
        const keyMaterial = await crypto.subtle.importKey(
            "raw", encoder.encode(keyMaterialStr), { name: "PBKDF2" }, false, ["deriveKey"]
        );
        return await crypto.subtle.deriveKey(
            { name: "PBKDF2", salt: salt, iterations: 100000, hash: "SHA-256" },
            keyMaterial, { name: "AES-GCM", length: 256 }, false, ["encrypt", "decrypt"]
        );
    }

    // ç¹ªè£½ã€ŒåŠ å¯†å°é¢åœ–ç‰‡ã€çš„å‡½æ•¸
    function generateCoverImage(fileName) {
        return new Promise((resolve) => {
            const canvas = document.createElement('canvas');
            canvas.width = 1024;
            canvas.height = 1024;
            const ctx = canvas.getContext('2d');

            // 1. èƒŒæ™¯ï¼šé»‘æ›œçŸ³æ·±è‰²
            ctx.fillStyle = "#050505";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // 2. è£é£¾ï¼šé‚Šæ¡†
            ctx.strokeStyle = "#00ffbf";
            ctx.lineWidth = 10;
            ctx.strokeRect(40, 40, canvas.width - 80, canvas.height - 80);

            // 3. æ–‡å­—è³‡è¨Š
            ctx.font = "bold 80px 'Noto Serif TC', serif";
            ctx.fillStyle = "#e0e0e0";
            ctx.textAlign = "center";
            ctx.fillText("æš— æ¸¡", canvas.width / 2, 250);

            ctx.font = "40px 'Cinzel', serif";
            ctx.fillStyle = "#00ffbf";
            ctx.fillText("TEMPORAL PROTOCOL", canvas.width / 2, 320);

            ctx.fillStyle = "#7a7a7a";
            ctx.font = "30px sans-serif";
            ctx.fillText("ENCRYPTED ARTIFACT", canvas.width / 2, 800);
            
            const now = new Date();
            ctx.fillText(`DATE: ${now.toISOString().split('T')[0]}`, canvas.width / 2, 850);
            ctx.fillText(`FILE: ${fileName.substring(0, 20)}...`, canvas.width / 2, 900);

            // 4. ç¹ªè£½ Logo (å˜—è©¦è¼‰å…¥)
            const img = new Image();
            img.onload = () => {
                // ç•« Logo åœ¨ä¸­é–“
                ctx.save();
                ctx.globalAlpha = 0.8;
                ctx.drawImage(img, (canvas.width - 300) / 2, 380, 300, 300);
                ctx.restore();
                canvas.toBlob(blob => resolve(blob), 'image/png');
            };
            img.onerror = () => {
                // å¦‚æœæ²’æœ‰ Logoï¼Œç•«ä¸€å€‹åœ“åœˆä»£æ›¿
                ctx.beginPath();
                ctx.arc(canvas.width/2, 530, 100, 0, 2 * Math.PI);
                ctx.fillStyle = "#111";
                ctx.fill();
                ctx.stroke();
                canvas.toBlob(blob => resolve(blob), 'image/png');
            };
            img.src = 'logo.png';
        });
    }

    async function processVideo(mode) {
        const password = document.getElementById('password').value;
        const files = document.getElementById('file-input').files;
        
        if (!password) { setStatus("éŒ¯èª¤ï¼šéœ€æ³¨å…¥é€šè¡Œå¯†ä»¤", "var(--spider-lily)"); return; }
        if (files.length === 0) { setStatus("éŒ¯èª¤ï¼šæœªæª¢æ¸¬åˆ°è¼‰é«”", "var(--spider-lily)"); return; }
        
        const file = files[0];
        document.getElementById('result-area').style.display = 'none';
        setStatus("å„€å¼å•Ÿå‹•...", "var(--ash-gray)", 5);

        try {
            if (mode === 'encrypt') {
                await encryptVideo(file, password);
            } else {
                await decryptVideo(file, password);
            }
        } catch (e) {
            console.error(e);
            setStatus("å„€å¼å¤±æ•—: " + e.message, "var(--spider-lily)");
        }
    }

    async function encryptVideo(file, password) {
        setStatus("è®€å–ä¸¦è§£æå½±åƒéˆé­‚...", "var(--ghost-cyan)", 10);
        const arrayBuffer = await file.arrayBuffer();
        
        setStatus("ç¹ªè£½åŠ å¯†ç¬¦å’’å°é¢...", "var(--ghost-cyan)", 20);
        const coverBlob = await generateCoverImage(file.name);
        const coverBuffer = await coverBlob.arrayBuffer();

        setStatus("æ ¡å°çµ•å°æ™‚é–“è»¸...", "var(--ghost-cyan)", 30);
        const salt = crypto.getRandomValues(new Uint8Array(16));
        const iv = crypto.getRandomValues(new Uint8Array(12));
        const key = await deriveKey(password, salt);
        
        setStatus("æ³¨å…¥ GCM å°å°...", "#00897b", 60);
        const encryptedContent = await crypto.subtle.encrypt(
            { name: "AES-GCM", iv: iv }, key, arrayBuffer
        );

        // çµæ§‹ï¼š[å°é¢PNG] + [åˆ†éš”ç¬¦] + [Salt] + [IV] + [å¯†æ–‡]
        // é€™æ¨£åšå‡ºçš„æª”æ¡ˆæ˜¯åˆæ³•çš„ PNGï¼Œæ‰‹æ©Ÿç›¸ç°¿å¯è®€å–
        setStatus("éš±å¯«è¡“åˆæˆä¸­...", "var(--bone-white)", 80);
        
        const totalLength = coverBuffer.byteLength + SEPARATOR.byteLength + salt.byteLength + iv.byteLength + encryptedContent.byteLength;
        const finalBuffer = new Uint8Array(totalLength);
        
        let offset = 0;
        finalBuffer.set(new Uint8Array(coverBuffer), offset); offset += coverBuffer.byteLength;
        finalBuffer.set(SEPARATOR, offset); offset += SEPARATOR.byteLength;
        finalBuffer.set(salt, offset); offset += salt.byteLength;
        finalBuffer.set(iv, offset); offset += iv.byteLength;
        finalBuffer.set(new Uint8Array(encryptedContent), offset);

        const finalBlob = new Blob([finalBuffer], {type: 'image/png'});
        const downloadUrl = URL.createObjectURL(finalBlob);
        const downloadBtn = document.getElementById('download-btn');
        
        downloadBtn.href = downloadUrl;
        downloadBtn.download = `ANDU_${Date.now()}.png`; // å­˜ç‚º .png
        
        document.getElementById('result-area').style.display = 'flex';
        document.getElementById('download-wrapper').style.display = 'block';
        document.getElementById('video-wrapper').style.display = 'none';
        setStatus("å°è£å®Œæˆã€‚è«‹ä¸‹è¼‰åœ–ç‰‡è‡³ç›¸ç°¿ã€‚", "var(--ghost-cyan)", 100);
    }

    async function decryptVideo(file, password) {
        setStatus("è®€å–åœ–ç‰‡çµæ§‹...", "var(--ghost-cyan)", 20);
        const fileBuffer = await file.arrayBuffer();
        const fileBytes = new Uint8Array(fileBuffer);
        
        setStatus("æœå°‹éš±å¯«è¡“ç—•è·¡...", "var(--ghost-cyan)", 30);
        
        // å°‹æ‰¾åˆ†éš”ç¬¦è™Ÿ SEPARATOR
        let separatorIndex = -1;
        // ç°¡å–®çš„æœå°‹ç®—æ³• (é€™åœ¨å‰ç«¯è™•ç†å¤§æª”å¯èƒ½æœƒæ…¢ï¼Œä½†ç‚ºäº†é‚è¼¯æ¸…æ™°å…ˆé€™æ¨£å¯«)
        // ç‚ºäº†æ•ˆèƒ½ï¼Œæˆ‘å€‘å¯ä»¥å¾æª”æ¡ˆä¸­é–“æˆ–å°¾éƒ¨é–‹å§‹æ‰¾ï¼Œæˆ–è€…å‡è¨­åœ–ç‰‡ä¸æœƒå¤ªå¤§
        // å„ªåŒ–ï¼šPNGé€šå¸¸åœ¨å‰é¢ï¼Œå¯†æ–‡åœ¨å¾Œé¢ï¼Œæˆ‘å€‘ç›´æ¥è·‘è¿´åœˆæ‰¾
        for(let i = 0; i < fileBytes.length - SEPARATOR.length; i++) {
            let match = true;
            for(let j = 0; j < SEPARATOR.length; j++) {
                if(fileBytes[i+j] !== SEPARATOR[j]) {
                    match = false;
                    break;
                }
            }
            if(match) {
                separatorIndex = i;
                break;
            }
        }

        if (separatorIndex === -1) {
            throw new Error("æ­¤åœ–ç‰‡æœªåŒ…å«æš—æ¸¡å¯†æ–‡ï¼Œæˆ–æ ¼å¼å·²ææ¯€ã€‚");
        }

        const payloadStart = separatorIndex + SEPARATOR.length;
        const payload = fileBytes.slice(payloadStart);

        if (payload.length < 28) throw new Error("å¯†æ–‡é•·åº¦ä¸è¶³");

        const salt = payload.slice(0, 16);
        const iv = payload.slice(16, 28);
        const ciphertext = payload.slice(28);

        setStatus("é©—è­‰æ™‚é–“æ³•å‰‡èˆ‡è§£å¯†...", "#00897b", 60);
        const key = await deriveKey(password, salt);

        try {
            const decryptedContent = await crypto.subtle.decrypt(
                { name: "AES-GCM", iv: iv }, key, ciphertext
            );

            setStatus("é¡¯å½±ä¸­...", "var(--bone-white)", 90);
            const videoBlob = new Blob([decryptedContent], { type: "video/mp4" });
            const videoUrl = URL.createObjectURL(videoBlob);
            const player = document.getElementById('player');
            player.src = videoUrl;
            
            document.getElementById('result-area').style.display = 'flex';
            document.getElementById('download-wrapper').style.display = 'none';
            document.getElementById('video-wrapper').style.display = 'block';
            setStatus("è§£å¯†æˆåŠŸã€‚å½±åƒå·²é‡ç¾ã€‚", "var(--ghost-cyan)", 100);

        } catch (e) {
            setStatus("è§£å¯†å¤±æ•—ï¼šæ™‚è¾°å·²éï¼Œæˆ–å¯†ä»¤éŒ¯èª¤ã€‚", "var(--spider-lily)");
        }
    }
</script>
</body>
</html>